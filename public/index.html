<!DOCTYPE html>
<html>

<head>
    <!-- Page's Title -->
    <title>Chat-Room 1.0</title>

    <!-- Page styling -->
    <link rel="stylesheet" type="text/css" href="style.css"/>

    <!-- Socket.IO client script -->
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <!-- User 'Log-In' area -->
    <div id = "loginArea">
        <form id="loginForm">
            <label><b>Enter your nickname bellow to join the chat-room: </b></label>
            <br /><br />
            <input class="inputArea1" id="nickname" />
            <input type="submit" class="button" value="Join"  />
        </form>
    </div>

    <!-- User Message Area -->
    <div id = "chatroomArea">
        <br />
        <div id = "chatroomHeader">
            <!-- List of currently connect users -->
            <p id = "connectedUsers" class = "userList" ><b>Connected Users:</b></p>
            <form class="customForm" id="messageForm" >
                <label><b>Write your message bellow: </b></label> <br />
                <textarea class="inputArea2" rows ="4" cols="50" id="message"></textarea>
                <br />
            </form>
            <br />
        </div>
        <br /><br /><br />

        <!-- Chat -->
        <div id="chat"></div>
    </div>


    <!-- This script forces textarea content to be sent after 'enter' is pressed -->
    <script type = "text/javascript">
        $("#message").keypress(function (e) {
            if(e.which == 13 && !e.shiftKey) {
                $(this).closest("form").submit();
                e.preventDefault();
            }
        });
    </script>

    <script>
        $(function(){
            // Connection
            var socket = io.connect();

            // Login 'screen' variables
            var $loginArea = $('#loginArea');
            var $loginForm = $('#loginForm');
            var $nickname = $('#nickname');

            // Chatroom variables
            var $chatroomArea = $('#chatroomArea');
            var $messageForm = $('#messageForm');
            var $message = $('#message');
            var $chat = $('#chat');
            var $connectedUsers = $('#connectedUsers');

            $chatroomArea.hide();   // Chatroom is not visible before choosing a nickname

            // Send the user's nickname to the server
            $loginForm.submit(function(e){
                // Prevent page from refreshing
                e.preventDefault();

                if ($nickname.val() != ''){
                    // Associate the nickname to the socket
                    socket.nickname = $nickname.val();

                    // Hide the login area and display the chatroom itself
                    $loginArea.hide();
                    $chatroomArea.show();

                    // Display a 'welcoming' message
                    $chat.append('<p class="systemMessage" ><i>Welcome <b>' + socket.nickname + '</b>! To communicate with the other users, write your message in the <b>Text Area</b> and press \'<b>ENTER</b>\' to send it!</i></p>');

                    // Notify the server that the new user chose a nickname
                    socket.emit('new client nickname' , socket.nickname);
                }
            });

            // Send the message to Server on 'Send' button click
            $messageForm.submit(function(e){
                // Prevent page from refreshing
                e.preventDefault();

                if ($message.val() != ''){
                    // Send message to the server
                    socket.emit('send message' , {content:$message.val() , nickname:socket.nickname});

                    // Clear the text textarea
                    $message.val('');
                }
            });

            // When receiving a message from the server, append it to the chat div
            socket.on('new message' , function(usermessage){
                var $msg = $('<p class="chatMessage">');
                var $msgNickname = $('<b>');
                var $msgContent = $('<text>');
                $msgNickname.append(usermessage.nickname + ':  ');
                $msgContent.text(usermessage.content);
                $msg.append($msgNickname);
                $msg.append($msgContent);

                $chat.append($msg);

                // Auto scroll to the bottom of the div
                $("#chat").prop({ scrollTop: $("#chat").prop("scrollHeight") });
            });

            // Update current users
            socket.on('update current users' , function(nicknames){
                var nicknamesList = '<b>Connected Users:</b>';
                for (i=0 ; i<nicknames.length ; i++){
                    if( i != 0 ){
                        nicknamesList += "&nbsp&nbsp&nbsp&nbsp&nbsp,";
                    }
                    nicknamesList += "&nbsp&nbsp&nbsp&nbsp&nbsp<i>" + nicknames[i] + "</i>";
                }
                $connectedUsers.html(nicknamesList);
            });

            // System message ; display it
            socket.on('system message' , function(message){
                $chat.append('<p class="systemMessage" ><i>' + message + '</i></p>');
            });
        });
    </script>


</body>


</html>
